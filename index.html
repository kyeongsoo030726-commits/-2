<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Leaves to Letters</title>
  <style>
    /* Title Font Faces */
    @font-face{font-family:'Aggravo';src:url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2108@1.1/SBAggroL.woff') format('woff');font-weight:300;font-display:swap;}
    @font-face{font-family:'Aggravo';src:url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2108@1.1/SBAggroM.woff') format('woff');font-weight:500;font-display:swap;}
    @font-face{font-family:'Aggravo';src:url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2108@1.1/SBAggroB.woff') format('woff');font-weight:700;font-display:swap;}

    /* Handwritten font */
    @font-face{
      font-family:'Cafe24Ssukssuk';
      src:url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_twelve@1.1/Cafe24Ssukssuk.woff') format('woff');
      font-weight:normal;font-display:swap;
    }
    .ssuk{ font-family:'Cafe24Ssukssuk', cursive; }
    .titlefont{ font-family:'Aggravo', system-ui, sans-serif; font-weight:700; }

    :root{
      --ui-border:#e5e7eb;
      --accent:#b45309;
      --text:#1f2937;
      --btn-bg:#ffffff;
      --btn-active:#b45309;
      --btn-active-text:#fff;
      --bar-bg:#fff;
      --bar-border:#e5e7eb;
      --bar-shadow:0 6px 24px rgba(0,0,0,.06);
      --label-brown:#6b3f23;
      --beige:#faf7f2;
      --white:#ffffff;
      --bubble-border:#e0d6c7;
      --bubble-bg:#fff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Aggravo',system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR',sans-serif;color:var(--text);}    

    /* ---------- Landing (ë²„íŠ¼ í´ë¦­ ë³´ì¥) ---------- */
    #landing{ position:relative; height:100%; display:grid; place-items:center; overflow:hidden; isolation:isolate; z-index:9999; pointer-events:auto; }
    .landing::before{content:"";position:absolute;inset:0;background:url('ë°°ê²½2.jpg') center/cover no-repeat;z-index:0;pointer-events:none;}
    .landing-inner{position:relative;z-index:2;text-align:center;padding:2rem 1rem;pointer-events:auto;}
    .btn-row{display:flex;gap:.9rem;justify-content:center;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--ui-border);background:#ffffffcc;color:#111;padding:1rem 1.4rem;border-radius:26px;font-weight:800;cursor:pointer;transition:.15s;position:relative;z-index:10000;pointer-events:auto;}
    .btn.accent{background:var(--accent);color:#fff;border-color:transparent}
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,0,0,.12)}

    /* ë©”ì¸ íƒ€ì´í‹€ */
    .title{color:#C64A21;margin:0;display:flex;flex-direction:column;align-items:center;gap:1rem}
    .title .line{display:flex;align-items:flex-end;gap:.6rem;white-space:nowrap}
    .title .word{font-weight:700;line-height:1;font-size:clamp(3.2rem,8vw,5.3rem)}
    .title .tilt{ display:inline-block;font-weight:700; font-size:clamp(1.6rem, 4vw, 2.667rem); transform:translateY(-0.2em) rotate(-12deg); color:#8C3A1A; letter-spacing:.02em; }
    .subtitle{font-weight:500;font-size:clamp(0.95rem, 2.2vw, 1.1rem);color:#9a6422;opacity:.98;margin:0.8rem 0 2.25rem;}

    /* ---------- App ---------- */
    .app{ display:none;height:100%;width:100%; background:linear-gradient(to bottom, var(--beige) 0 88.888%, var(--white) 88.888% 100%); }
    .app-inner{height:100%;display:grid;grid-template-columns:1fr 360px;gap:16px;padding:16px}
    .workspace{display:flex;flex-direction:column;align-items:center}

    /* ---------- ìƒë‹¨: ë™ë¬¼2 + ì°½ê³  ---------- */
    .pool-row-line{width:min(860px,80%);display:flex;align-items:flex-start;gap:16px;justify-content:flex-start;margin:40px auto 10px;}
    .pool-deco-left{width:166px;height:auto;object-fit:contain}
    .pool-col{flex:1;display:flex;flex-direction:column;gap:10px;min-width:0}

    .pool-bar{ position:relative;flex:1;background:var(--bar-bg);border:1px solid var(--bar-border); border-radius:16px;box-shadow:var(--bar-shadow); padding:44px 14px 16px; /* ìƒë‹¨ ì•ˆìª½ ì—¬ë°± ìœ ì§€ */ margin-top:14px; max-width:92%; display:flex;align-items:center;gap:14px;justify-content:center; }
    .pool-title{ position:absolute; top:8px; left:50%; transform:translateX(-50%); margin:0; font-weight:700; color:#5b3a2a; padding:0; }

    .pool-row{flex:1;display:flex;justify-content:center;gap:18px;flex-wrap:wrap}
    .pool{display:flex;flex-direction:column;align-items:center;gap:2px}
    .pool .label{font-weight:700;color:var(--label-brown);font-size:1rem;margin-bottom:0}
    .pool-slot{position:relative;width:110px;height:74px;display:grid;place-items:center;overflow:hidden;border-radius:10px}
    .pool-item{width:auto;height:auto;max-width:100px;max-height:67px;object-fit:contain;cursor:pointer;user-select:none;touch-action:none}

    /* ---------- ë§í’ì„  (ê³¡ì„  ê¼¬ë¦¬ ì§€ì›) ---------- */
    .speech-bubble{ position:relative; color:#4a3a2a;background:var(--bubble-bg);border:2px solid var(--bubble-border);border-radius:28px; padding:6px 16px 12px 16px; line-height:1.4;white-space:pre-line; max-width:520px; filter:drop-shadow(0 4px 10px rgba(0,0,0,.06)); }
    .speech-bubble.compact{ padding-top:4px; }
    /* ê³¡ì„  ê¼¬ë¦¬: SVGë¡œ ê°ë„ íšŒì „ */
    .fade-out{animation:fade .4s ease forwards;} @keyframes fade{to{opacity:0;transform:translateY(-4px);}}

    /* ---------- ì—½ì„œ ì˜ì—­ ---------- */
    .canvas-row{display:flex;align-items:flex-end;gap:16px}
    .sketch-wrap{position:relative}
    .sketch{ position:relative;width:1000px;height:650px;overflow:hidden;border-radius:16px; background:url('ì—½ì„œ1.png') center/contain no-repeat;margin:0 auto; }
    .overlay-top{ position:absolute; left:16px; top:16px; z-index:7; }

    .animal-right{width:200px;height:auto;object-fit:contain}
    .animal-right-wrap{ position:relative; display:inline-block; }
    .animal-right-wrap .speech-bubble{ position:absolute; bottom:calc(100% + 8px); right:0; max-width:260px; opacity:.7; font-size:0.92rem; }

    .layer,.leaves-layer{position:absolute;inset:0}
    canvas.layer{pointer-events:none;z-index:5}
    #drawCanvas{pointer-events:none}
    #stampCanvas{pointer-events:none;z-index:4}
    .leaves-layer{z-index:3}
    .movable{position:absolute;cursor:grab;user-select:none;touch-action:none;transform-origin:center center}
    .ghost{position:absolute;z-index:6;pointer-events:none;opacity:.95;transform-origin:center center}

    /* ---------- Right panel ---------- */
    .side{ position:fixed;right:0;top:0;bottom:0;z-index:10; width:360px;padding:18px 16px 100px;overflow:auto;background:transparent; box-shadow:-18px 0 28px rgba(0,0,0,.08);border:none; }

    /* íŒ¨ë„ ìƒë‹¨ 'Leaves to Letters' íƒ€ì´í‹€ */
    .side-title{ color:#C64A21;margin:2px 0 36px 0; display:flex; flex-direction:column; align-items:center; gap:.6rem; width:100%; }
    .side-title .line{display:flex;align-items:flex-end;gap:.4rem;white-space:nowrap}
    .side-title .word{font-weight:700;line-height:1;font-size:clamp(1.6rem, 5.6vw, 2.2rem)}
    .side-title .tilt{ display:inline-block;font-weight:700; font-size:clamp(1.05rem, 3.4vw, 1.5rem); transform:translateY(-0.2em) rotate(-12deg); color:#8C3A1A; letter-spacing:.02em; }

    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{appearance:none;border:1px solid var(--ui-border);background:var(--btn-bg);color:#111;padding:.7rem 1rem;border-radius:20px;font-weight:700;cursor:pointer;transition:.15s}
    .pill.active{background:var(--btn-active);border-color:var(--btn-active);color:var(--btn-active-text);box-shadow:0 8px 20px rgba(180,83,9,.25)}
    .tool-block{margin:28px 0}
    .tool-controls{margin-top:12px;display:flex;flex-direction:column;gap:12px}
    .tool-controls .row>label{display:flex;align-items:center;gap:8px}

    /* Save ë²„íŠ¼ */
    .save-fab{ position:fixed;right:30px;bottom:30px;z-index:60; appearance:none;border:none;background:var(--accent);color:#fff;padding:.9rem 1.2rem;border-radius:24px;font-weight:800;cursor:pointer; box-shadow:0 10px 26px rgba(0,0,0,.2); display:none; }

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:50}
    .modal.open{display:flex}
    .modal-card{position:relative;max-width:min(92vw,1000px);max-height:86vh;background:#111;border-radius:16px;overflow:hidden;box-shadow:0 16px 64px rgba(0,0,0,.35)}
    .modal-card img{display:block;max-width:100%;max-height:86vh;object-fit:contain}
    .modal-close{position:absolute;top:10px;right:10px;background:#00000088;color:#fff;border:none;width:36px;height:36px;border-radius:999px;cursor:pointer;font-weight:900}

    @media (max-width:1140px){
      .app-inner{grid-template-columns:1fr}
      .side{position:static;width:auto;order:-1;padding:16px;box-shadow:none}
      .sketch{width:92vw;height:calc(92vw * 0.65)}
      .pool-slot{width:100px;height:66px}
      .pool-item{max-width:90px;max-height:60px}
      .animal-right{width:18vw}
      .save-fab{right:16px;bottom:16px}
      .canvas-row{justify-content:center}
      .pool-row-line{width:92vw}
    }
  </style>
</head>
<body>
  <!-- Landing -->
  <section class="landing" id="landing">
    <div class="landing-inner">
      <h1 class="title" aria-label="Leaves to Letters">
        <div class="line"><span class="word">Leaves</span></div>
        <div class="line"><span class="tilt">to</span> <span class="word">Letters</span></div>
      </h1>
      <div class="subtitle">Little memories made of autumn leaves</div>
      <div class="btn-row">
        <button class="btn accent" id="startApp" type="button">Start</button>
      </div>
    </div>
  </section>

  <!-- App -->
  <section class="app" id="app">
    <div class="app-inner">
      <div class="workspace">
        <!-- ì¢Œ: ë™ë¬¼2 / ìš°: ì°½ê³  -->
        <div class="pool-row-line">
          <img src="ë™ë¬¼2.png" alt="ë™ë¬¼2" class="pool-deco-left" id="animalLeft"/>
          <div class="pool-col">
            <div class="pool-bar">
              <h3 class="pool-title">ğŸŒ° ë‹¤ëŒì¥ì˜ ê°€ì„ ì°½ê³  ğŸŒ°</h3>
              <div class="pool-row">
                <div class="pool">
                  <div class="label ssuk">ë‚™ì—½</div>
                  <div class="pool-slot"><img class="pool-item" id="poolLeaf" alt="leaf"/></div>
                </div>
                <div class="pool">
                  <div class="label ssuk">ì—´ë§¤</div>
                  <div class="pool-slot"><img class="pool-item" id="poolFruit" alt="fruit"/></div>
                </div>
                <div class="pool">
                  <div class="label ssuk">ë‚˜ë­‡ê°€ì§€</div>
                  <div class="pool-slot"><img class="pool-item" id="poolBranch" alt="branch"/></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ì—½ì„œ + ì˜¤ë¥¸ìª½ ë™ë¬¼3 (+ ì•ˆë‚´ ë§í’ì„ ) -->
        <div class="canvas-row">
          <div class="sketch-wrap">
            <div class="sketch" id="sketch">
              <div class="leaves-layer" id="leavesLayer"></div>
              <canvas class="layer" id="stampCanvas" width="1000" height="650"></canvas>
              <canvas class="layer" id="drawCanvas" width="1000" height="650"></canvas>

              <!-- ì—½ì„œ ìœ„ì— ê²¹ì³ì„œ 7ì´ˆ í›„ ì‚¬ë¼ì§€ëŠ” ì•ˆë‚´ (ì¢Œì¸¡ìœ¼ë¡œ ì´ë™ & 70% íˆ¬ëª…, ì¢Œìƒ ê³¡ì„ ê¼¬ë¦¬) -->
              <div class="speech-bubble ssuk overlay-top" id="introBubble" role="status" style="opacity:.7">
ê°€ì„ì„ ê°€ë“ ë‹´ì€ ì—½ì„œë¥¼ ê¾¸ë©°ë³´ì„¸ìš”!
  <svg class="tail-svg" id="introTail" width="36" height="36" viewBox="0 0 36 36" style="position:absolute; left:-6px; top:-6px; overflow:visible">
    <path id="introTailPath" d="M2,2 Q18,22 34,34" fill="none" stroke="var(--bubble-border)" stroke-width="2" stroke-linecap="round"/>
  </svg>
</div>
            </div>
          </div>

          <!-- ë™ë¬¼3 ìœ„ ì•ˆë‚´ ë§í’ì„  (í…ìŠ¤íŠ¸ ë³€ê²½, ìƒë‹¨ íŒ¨ë”© ì¶•ì†Œ, ìš°í•˜ ê³¡ì„ ê¼¬ë¦¬) -->
          <div class="animal-right-wrap">
            <div class="speech-bubble ssuk compact" id="wheelHelp">
ë§ˆìš°ìŠ¤ íœ ì„ êµ´ë¦¬ë©´
ì—½ì„œ ìœ„ ì´ë¯¸ì§€ê°€ íšŒì „í•´ìš”!

ì—½ì„œ ìœ„ì— ì˜¬ë¦° ì´ë¯¸ì§€ë¥¼
ë“œë˜ê·¸í•˜ë©´
ìœ„ì¹˜ë¥¼ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”!
  <svg class="tail-svg" id="wheelTail" width="36" height="36" viewBox="0 0 36 36" style="position:absolute; right:-6px; bottom:-6px; overflow:visible">
    <path id="wheelTailPath" d="M2,2 Q18,22 34,34" fill="none" stroke="var(--bubble-border)" stroke-width="2" stroke-linecap="round"/>
  </svg>
</div>
            <img src="ë™ë¬¼3.png" alt="ë™ë¬¼3" class="animal-right"/>
          </div>
        </div>
      </div>

      <!-- ìš°ì¸¡ íˆ´ -->
      <aside class="side">
        <!-- íŒ¨ë„ íƒ€ì´í‹€ -->
        <div class="side-title" aria-label="Leaves to Letters">
          <div class="line"><span class="word">Leaves</span></div>
          <div class="line"><span class="tilt">to</span> <span class="word">Letters</span></div>
        </div>

        <div class="tool-block">
          <div class="row">
            <button class="pill" id="toolNone" aria-label="ì„ íƒ ëª¨ë“œ" type="button">ğŸ¤š ì„ íƒëª¨ë“œ</button>
            <button class="pill" id="btnUndo" aria-label="ì‹¤í–‰ ì·¨ì†Œ" type="button">â†¶</button>
            <button class="pill" id="btnRedo" aria-label="ì‹¤í–‰" type="button">â†·</button>
          </div>
        </div>

        <div class="tool-block" id="block-crayon">
          <button class="pill" id="btnCrayon" aria-label="í¬ë ˆíŒŒìŠ¤" type="button">í¬ë ˆíŒŒìŠ¤</button>
          <div class="tool-controls">
            <div class="row"><label class="ssuk">ìƒ‰ìƒ <input type="color" id="penColor" value="#3B3B3B"></label></div>
            <div class="row"><label class="ssuk">êµµê¸° <input type="range" id="penSize" min="2" max="40" value="12"></label></div>
          </div>
        </div>

        <div class="tool-block" id="block-eraser">
          <button class="pill" id="btnEraser" aria-label="ì§€ìš°ê°œ" type="button">ì§€ìš°ê°œ</button>
          <div class="tool-controls">
            <div class="row"><label class="ssuk">í¬ê¸° <input type="range" id="eraserSize" min="5" max="40" value="16"></label></div>
          </div>
        </div>

        <div class="tool-block" id="block-trash">
          <button class="pill" id="btnTrash" aria-label="íœ´ì§€í†µ" type="button">íœ´ì§€í†µ</button>
          <div class="tool-controls">
            <div class="row"><small class="ssuk">í™œì„±í™” í›„ ì—½ì„œ ìœ„ ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ ì‚­ì œë©ë‹ˆë‹¤.</small></div>
          </div>
        </div>

        <div class="tool-block" id="block-stamp">
          <button class="pill" id="btnStamp" aria-label="ë„ì¥" type="button">ë„ì¥</button>
          <div class="tool-controls">
            <div class="row" id="stampChooser" style="gap:8px;flex-wrap:wrap"></div>
          </div>
        </div>
      </aside>
    </div>
  </section>

  <!-- Save FAB -->
  <button class="save-fab" id="saveBtn" type="button">ì—½ì„œ ë³´ë‚´ê¸°</button>

  

  <script>
    /* ---------- Landing â†’ App ---------- */
    const landing=document.getElementById('landing');
    const app=document.getElementById('app');
    const saveFab=document.getElementById('saveBtn');

    const startBtn = document.getElementById('startApp');

   

    // ì•±ì€ ì²˜ìŒì—” í´ë¦­ ë¹„í™œì„± (ëœë”©ì´ ìµœìƒìœ„)
    app.style.pointerEvents = 'none';

    function openApp(e){
      e?.preventDefault?.();
      landing.style.display='none';
      app.style.display='block';
      app.style.pointerEvents = 'auto';
      saveFab.style.display='inline-flex';
      regenAllPools();
      pushStateIfChanged();
      scheduleIntroBubbleRemoval(); // 7ì´ˆ
      placeIntroBubbleLeft();       // ì¢Œì¸¡ ì •ë ¬ + ë™ë¬¼2/ë°” ì‚¬ì´
    }

    startBtn.addEventListener('click', openApp, {passive:false});
 

    // ì—½ì„œ ìœ„ ì•ˆë‚´ ë§í’ì„  7ì´ˆ í›„ ì œê±°
    function scheduleIntroBubbleRemoval(){
      const bubble=document.getElementById('introBubble');
      if(!bubble) return;
      setTimeout(()=>{
        bubble.classList.add('fade-out');
        bubble.addEventListener('animationend',()=>bubble.remove(),{once:true});
      },7000);
    }

    // ë§í’ì„ ì„ ë™ë¬¼2ì™€ ë°” ì‚¬ì´ ì¤‘ê°„ ìœ„ì¹˜ë¡œ, ì¢Œìƒë‹¨ ê¼¬ë¦¬ëŠ” ë™ë¬¼2ë¥¼ í–¥í•˜ê²Œ
    function placeIntroBubbleLeft(){
      const bubble=document.getElementById('introBubble');
      const img=document.getElementById('animalLeft');
      const bar=document.querySelector('.pool-bar');
      const sketchEl=document.getElementById('sketch');
      if(!bubble||!img||!bar||!sketchEl) return;
      requestAnimationFrame(()=>{
        const br=bubble.getBoundingClientRect();
        const ir=img.getBoundingClientRect();
        const ar=bar.getBoundingClientRect();
        const pr=sketchEl.getBoundingClientRect();
        const midX = (ir.right + ar.left)/2;
        const left = Math.max(8, midX - br.width/2 - pr.left);
        bubble.style.left = left + 'px';
        // ê¼¬ë¦¬ë¥¼ ë™ë¬¼2 ë°©í–¥ìœ¼ë¡œ íšŒì „
        pointTailToTarget(document.getElementById('introTail'), bubble, img);
      });
    }

    /* ---------- Refs ---------- */
    const poolLeaf=document.getElementById('poolLeaf');
    const poolFruit=document.getElementById('poolFruit');
    const poolBranch=document.getElementById('poolBranch');
    const leavesLayer=document.getElementById('leavesLayer');
    const sketch=document.getElementById('sketch');
    const drawCanvas=document.getElementById('drawCanvas'); const dctx=drawCanvas.getContext('2d');
    const stampCanvas=document.getElementById('stampCanvas'); const sctx=stampCanvas.getContext('2d');

    /* ---------- Assets ---------- */
    const fruitImgs=['ì—´ë§¤1.png','ì—´ë§¤2.png','ì—´ë§¤3.png','ì—´ë§¤4.png','ì—´ë§¤5.png','ì—´ë§¤6.png','ì—´ë§¤7.png','ì—´ë§¤8.png','ì—´ë§¤9.png'];
    const branchImgs=['ë‚˜ë­‡ê°€ì§€1.png','ë‚˜ë­‡ê°€ì§€2.png','ë‚˜ë‡»ê°€ì§€3.png','ë‚˜ë­‡ê°€ì§€4.png','ë‚˜ë­‡ê°€ì§€5.png','ë‚˜ë­‡ê°€ì§€6.png','ë‚˜ë­‡ê°€ì§€7.png','ë‚˜ë­‡ê°€ì§€8.png','ë‚˜ë­‡ê°€ì§€9.png','ë‚˜ë­‡ê°€ì§€10.png','ë‚˜ë‡Ÿê°€ì§€11.png','ë‚˜ë­‡ê°€ì§€12.png','ë‚˜ë­‡ê°€ì§€13.png'].map(x=>x.replace('ë‚˜ë‡Ÿ','ë‚˜ë­‡')); // ì˜¤íƒ€ ë³´ì •
    const leafImgs=['ë‚™ì—½1.png','ë‚™ì—½2.png','ë‚™ì—½3.png','ë‚™ì—½4.png','ë‚™ì—½5.png','ë‚™ì—½6.png','ë‚™ì—½7.png','ë‚™ì—½8.png','ë‚™ì—½9.png','ë‚™ì—½10.png','ë‚™ì—½11.png','ë‚™ì—½12.png','ë‚™ì—½13.png','ë‚™ì—½14.png','ë‚™ì—½15.png','ë‚™ì—½16.png','ë‚™ì—½17.png','ë‚™ì—½18.png','ë‚™ì—½19.png','ë‚™ì—½20.png','ë‚™ì—½21.png','ë‚™ì—½22.png','ë‚™ì—½23.png','ë‚™ì—½24.png','ë‚™ì—½25.png','ë‚™ì—½26.png','ë‚™ì—½27.png','ë‚™ì—½28.png','ë‚™ì—½29.png','ë‚™ì—½30.png','ë‚™ì—½31.png','ë‚™ì—½32.png','ë‚™ì—½33.png','ë‚™ì—½34.png','ë‚™ì—½35.png','ë‚™ì—½36.png','ë‚™ì—½37.png','ë‚™ì—½38.png','ë‚™ì—½39.png','ë‚™ì—½40.png','ë‚™ì—½41.png'];
    const stampImgs=['ë„ì¥1.png','ë„ì¥2.png','ë„ì¥3.png','ë„ì¥4.png'];

    /* ---------- Utils ---------- */
    const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    const isSmallFruit=(src)=>/ì—´ë§¤1\.png$|ì—´ë§¤6\.png$/.test(src||'');

    /* ---------- Sizes ---------- */
    const POSTCARD_W = 1000;
    const GLOBAL_SCALE = 7;
    const REDUCE = 1/1.5;
    const UNIFORM_W = Math.round((POSTCARD_W/50) * GLOBAL_SCALE * REDUCE);

    /* ---------- Pools ---------- */
    function regenPool(imgEl,list){
      const src=list[Math.floor(Math.random()*list.length)];
      imgEl.src=src;
      imgEl.style.maxWidth='100px'; imgEl.style.maxHeight='67px';
      imgEl.style.objectFit='contain';
      imgEl.style.transform=`rotate(${rnd(0,380)}deg)`;
      imgEl.draggable=false;
    }
    function regenAllPools(){regenPool(poolLeaf,leafImgs);regenPool(poolFruit,fruitImgs);regenPool(poolBranch,branchImgs);}

    /* ---------- Placement ghost (click-to-place) ---------- */
    let placeMode=false, placeSrc=null, placeGhost=null, ghostRot=0;
    function widthForSrc(src){ return isSmallFruit(src) ? Math.round(UNIFORM_W/3) : UNIFORM_W; }

    function beginPlacementFrom(imgEl, kindName){
      if(!imgEl.src) return;
      placeSrc=imgEl.src; placeMode=true;
      ghostRot=rnd(0,380);

      if(placeGhost) placeGhost.remove();
      placeGhost=document.createElement('img');
      placeGhost.src=placeSrc; placeGhost.className='ghost';
      const ghostW = widthForSrc(placeSrc);
      placeGhost.style.width=ghostW+'px'; placeGhost.style.height='auto'; placeGhost.style.objectFit='contain';
      placeGhost.style.transform=`rotate(${ghostRot}deg)`;
      leavesLayer.appendChild(placeGhost);

      const moveGhost=(ev)=>{
        const pr=leavesLayer.getBoundingClientRect();
        const b=placeGhost.getBoundingClientRect();
        const x=clamp(ev.clientX-pr.left-b.width/2,0,pr.width-b.width);
        const y=clamp(ev.clientY-pr.top -b.height/2,0,pr.height-b.height);
        placeGhost.style.left=x+'px'; placeGhost.style.top=y+'px';
      };
      const placeAt=()=>{
        if(!placeMode) return;
        const el=createMovable(placeSrc,widthForSrc(placeSrc),ghostRot);
        el.style.left=placeGhost.style.left;
        el.style.top =placeGhost.style.top;
        endPlacement();
        if(kindName==='leaf') regenPool(poolLeaf,leafImgs);
        if(kindName==='fruit') regenPool(poolFruit,fruitImgs);
        if(kindName==='branch') regenPool(poolBranch,branchImgs);
        pushStateIfChanged();
      };
      sketch.addEventListener('pointermove',moveGhost);
      sketch.addEventListener('click',placeAt,{once:true});

      function endPlacement(){
        placeMode=false; placeSrc=null;
        sketch.removeEventListener('pointermove',moveGhost);
        sketch.removeEventListener('click',placeAt);
        placeGhost?.remove(); placeGhost=null;
      }
    }
    poolLeaf.addEventListener('click',()=>beginPlacementFrom(poolLeaf,'leaf'));
    poolFruit.addEventListener('click',()=>beginPlacementFrom(poolFruit,'fruit'));
    poolBranch.addEventListener('click',()=>beginPlacementFrom(poolBranch,'branch'));

    /* ---------- Movables ---------- */
    function createMovable(src,w,rot){
      const el=document.createElement('img');
      el.src=src; el.className='movable'; el.draggable=false;
      el.style.width=w+'px'; el.style.height='auto'; el.style.objectFit='contain';
      el.dataset.rotation=rot; el.style.transform=`rotate(${rot}deg)`;
      leavesLayer.appendChild(el);
      makeDraggable(el);
      return el;
    }
    function moveTo(el,x,y){
      const pr=leavesLayer.getBoundingClientRect();
      const rect=el.getBoundingClientRect();
      const w=rect.width||parseFloat(el.style.width)||UNIFORM_W;
      const h=rect.height||(w*0.66);
      const cx=clamp(x,0,pr.width-w), cy=clamp(y,0,pr.height-h);
      el.style.left=cx+'px'; el.style.top=cy+'px';
    }
    function makeDraggable(el){
      let down=false, offX=0, offY=0;
      const onDown=(e)=>{
        if(tool==='trash'){ e.preventDefault(); return; }
        e.preventDefault(); down=true; el.setPointerCapture(e.pointerId); el.style.cursor='grabbing';
        const r=el.getBoundingClientRect(); offX=e.clientX-r.left; offY=e.clientY-r.top;
        document.addEventListener('pointermove',onMove); document.addEventListener('pointerup',onUp);
      };
      const onMove=(ev)=>{ if(!down) return; const pr=leavesLayer.getBoundingClientRect(); moveTo(el, ev.clientX-pr.left-offX, ev.clientY-pr.top-offY); };
      const onUp=(ev)=>{ if(!down) return; down=false; el.style.cursor='grab'; el.releasePointerCapture(ev.pointerId);
        document.removeEventListener('pointermove',onMove); document.removeEventListener('pointerup',onUp);
        pushStateIfChanged();
      };
      el.addEventListener('pointerdown',onDown);
      el.addEventListener('click',(e)=>{ if(tool==='trash'){ e.stopPropagation(); el.remove(); pushStateIfChanged(); } });
    }

    /* ---------- ë§ˆìš°ìŠ¤ íœ  íšŒì „ ---------- */
    const ROT_STEP = 5;

    // ê³µí†µ: ê¼¬ë¦¬ SVGë¥¼ íƒ€ê¹ƒ ë°©í–¥ìœ¼ë¡œ íšŒì „ì‹œí‚¤ëŠ” í•¨ìˆ˜
    function pointTailToTarget(svgEl, bubbleEl, targetEl){
      if(!svgEl||!bubbleEl||!targetEl) return;
      const b = bubbleEl.getBoundingClientRect();
      const t = targetEl.getBoundingClientRect();
      const svgRect = svgEl.getBoundingClientRect();
      const anchor = { x: (svgRect.left + svgRect.right)/2, y: (svgRect.top + svgRect.bottom)/2 };
      const target = { x: (t.left + t.right)/2, y: (t.top + t.bottom)/2 };
      const ang = Math.atan2(target.y - anchor.y, target.x - anchor.x) * 180/Math.PI;
      svgEl.style.transformOrigin = '18px 18px';
      svgEl.style.transform = `rotate(${ang}deg)`;
    }

    sketch.addEventListener('wheel',(e)=>{
      e.preventDefault();
      const dir = (e.deltaY>0) ? ROT_STEP : -ROT_STEP;

      const target = e.target.closest?.('.movable');
      if(target){
        const cur = parseFloat(target.dataset.rotation||'0');
        const next = cur + dir;
        target.dataset.rotation = next;
        target.style.transform = `rotate(${next}deg)`;
        schedulePush();  // ë””ë°”ìš´ìŠ¤ ìŠ¤ëƒ…ìƒ·
        return;
      }
      if(placeGhost){
        ghostRot = (ghostRot||0) + dir;
        placeGhost.style.transform = `rotate(${ghostRot}deg)`;
        return;
      }
      if(stampGhost){
        stampRot = (stampRot||0) + dir;
        stampGhost.style.transform = `rotate(${stampRot}deg)`;
        return;
      }
    }, {passive:false});

    /* ---------- Brush (í¬ë ˆíŒŒìŠ¤) ---------- */
    dctx.lineCap='round'; dctx.lineJoin='round';
    let tool='none', strokes=[], drawing=false, last={x:0,y:0}, penColor='#3B3B3B', penSize=12;
    const brushTipImg=new Image(); /* ê°™ì€ ì˜¤ë¦¬ì§„ì´ë©´ crossOrigin ë¶ˆí•„ìš” */ brushTipImg.src='í¬ë ˆíŒŒìŠ¤.png';
    const brushCache=new Map();
    function tintedBrush(size,color){
      const key=size+'|'+color;
      if(brushCache.has(key)) return brushCache.get(key);
      const c=document.createElement('canvas'); c.width=c.height=size;
      const cctx=c.getContext('2d'); cctx.imageSmoothingEnabled=true;
      if (brushTipImg.complete && brushTipImg.naturalWidth > 0) {
        // ì •ìƒ: í…ìŠ¤ì²˜ì— ìƒ‰ ì…íˆê¸°
        cctx.drawImage(brushTipImg,0,0,size,size);
        cctx.globalCompositeOperation='source-in'; 
        cctx.fillStyle=color; 
        cctx.fillRect(0,0,size,size);
        cctx.globalCompositeOperation='source-over';
      } else {
        // í´ë°±: ê·¸ëƒ¥ ì»¬ëŸ¬ ì›í˜• íŒ
        cctx.fillStyle = color;
        cctx.beginPath();
        cctx.arc(size/2, size/2, size/2, 0, Math.PI*2);
        cctx.fill();
      }
      brushCache.set(key,c); return c;
    }
    function toLocal(ev){
      const r=drawCanvas.getBoundingClientRect();
      const x=(ev.clientX-r.left)*(drawCanvas.width/r.width);
      const y=(ev.clientY-r.top )*(drawCanvas.height/r.height);
      return {x:clamp(x,0,drawCanvas.width), y:clamp(y,0,drawCanvas.height)};
    }
    function stampSeg(ctx,a,b,size,color){
      const tip=tintedBrush(size,color);
      const dx=b.x-a.x, dy=b.y-a.y, dist=Math.hypot(dx,dy);
      if(!dist){
        if (tip) ctx.drawImage(tip,a.x-size/2,a.y-size/2);
        else { ctx.fillStyle=color; ctx.beginPath(); ctx.arc(a.x,a.y,size/2,0,Math.PI*2); ctx.fill(); }
        return;
      }
      const step=Math.max(1,size*0.35), ux=dx/dist, uy=dy/dist;
      for(let d=0; d<=dist; d+=step){
        const x=a.x+ux*d, y=a.y+uy*d;
        if (tip) ctx.drawImage(tip, x-size/2, y-size/2);
        else { ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x,y,size/2,0,Math.PI*2); ctx.fill(); }
      }
    }
    function redrawAll(){
      dctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
      for(const s of strokes){
        for(let i=0;i<s.points.length-1;i++){ stampSeg(dctx,s.points[i],s.points[i+1],s.size,s.color); }
      }
    }
    function startDraw(ev){
      if(tool!=='pen' && tool!=='eraser') return;
      const p=toLocal(ev);
      if(tool==='eraser'){
        drawing=true; last=p; dctx.globalCompositeOperation='destination-out';
        dctx.lineWidth=+eraserSize.value; dctx.beginPath(); dctx.moveTo(p.x,p.y);
      }else{
        if(!brushTipImg.complete && brushTipImg.decode){ brushTipImg.decode().catch(()=>{}); }
        drawing=true; last=p;
        const s={color:penColor,size:penSize,points:[{x:p.x,y:p.y}]};
        strokes.push(s);
        stampSeg(dctx,p,p,penSize,penColor);
      }
    }
    function moveDraw(ev){
      if(!drawing) return;
      const p=toLocal(ev);
      if(tool==='eraser'){ dctx.lineTo(p.x,p.y); dctx.stroke(); last=p; }
      else { strokes.at(-1).points.push({x:p.x,y:p.y}); stampSeg(dctx,last,p,penSize,penColor); last=p; }
    }
    function endDraw(){
      if(!drawing) return;
      if(tool==='eraser') dctx.globalCompositeOperation='source-over';
      drawing=false;
      pushStateIfChanged();
    }
    drawCanvas.addEventListener('pointerdown',startDraw);
    drawCanvas.addEventListener('pointermove',moveDraw);
    window.addEventListener('pointerup',endDraw);

    /* ---------- Tool buttons ---------- */
    const toolNoneBtn=document.getElementById('toolNone');
    const btnCrayon=document.getElementById('btnCrayon');
    const btnEraser=document.getElementById('btnEraser');
    const btnTrash=document.getElementById('btnTrash');
    const btnStamp=document.getElementById('btnStamp');
    const penColorEl=document.getElementById('penColor');
    const penSizeEl=document.getElementById('penSize');
    const eraserSize=document.getElementById('eraserSize');

    function setTool(next){
      if(tool===next){ next='none'; }
      tool=next;
      btnCrayon.classList.toggle('active', tool==='pen');
      btnEraser.classList.toggle('active', tool==='eraser');
      btnTrash.classList.toggle('active', tool==='trash');
      btnStamp.classList.toggle('active', tool==='stamp');
      toolNoneBtn.classList.toggle('active', tool==='none');
      drawCanvas.style.pointerEvents = (tool==='pen'||tool==='eraser')? 'auto':'none';
      // ë“œë¡œì‰ ì¸µì´ í•­ìƒ ìœ„ì—ì„œ í¬ì¸í„° ë°›ë„ë¡ ë³´ì •
      if (tool==='pen' || tool==='eraser') {
        drawCanvas.style.zIndex = 6; // ìŠ¤íƒ¬í”„(4)ë³´ë‹¤ ìœ„ìª½
      } else {
        drawCanvas.style.zIndex = 5;
      }
      if(tool!=='stamp'){ cancelStampGhost(); }
    }
    function cancelStampGhost(){
      stampMode=false; activeStamp=null;
      if(stampGhost){ stampGhost.remove(); stampGhost=null; }
    }
    toolNoneBtn.addEventListener('click',()=>setTool('none'));
    btnCrayon.addEventListener('click',()=>setTool('pen'));
    btnEraser.addEventListener('click',()=>setTool('eraser'));
    btnTrash.addEventListener('click',()=>setTool('trash'));
    btnStamp.addEventListener('click',()=>setTool('stamp'));
    penColorEl.addEventListener('input',e=>{ penColor=e.target.value; if(tool!=='pen') setTool('pen'); });
    penSizeEl.addEventListener('input',e=>{ penSize=+e.target.value; if(tool!=='pen') setTool('pen'); });

    /* ---------- Stamps ---------- */
    const stampChooser=document.getElementById('stampChooser');
    let stampMode=false, activeStamp=null, stampImageObj=null, stampGhost=null, stampRot=0;
    function buildStamps(){
      stampChooser.innerHTML='';
      stampImgs.forEach(src=>{
        const im=document.createElement('img');
        im.src=src; im.alt=src; im.title=src.replace('.png','');
        im.style.width='64px'; im.style.height='64px'; im.style.objectFit='contain';
        im.style.border='1px solid var(--ui-border)'; im.style.borderRadius='10px'; im.style.padding='6px';
        im.style.cursor='pointer'; im.style.background='#fff';
        im.addEventListener('click',()=>{
          if(tool!=='stamp') setTool('stamp');
          activeStamp=src; stampImageObj=new Image(); stampImageObj.src=src; stampMode=true;
          stampRot=rnd(-45,45);
          if(stampGhost) stampGhost.remove();
          stampGhost=document.createElement('img');
          stampGhost.src=src; stampGhost.className='ghost';
          const size=100;
          stampGhost.style.width=size+'px'; stampGhost.style.height='auto'; stampGhost.style.objectFit='contain';
          stampGhost.style.transform=`rotate(${stampRot}deg)`;
          leavesLayer.appendChild(stampGhost);

          const moveGhost=(ev)=>{
            const pr=leavesLayer.getBoundingClientRect();
            const b=stampGhost.getBoundingClientRect();
            const x=clamp(ev.clientX-pr.left-b.width/2,0,pr.width-b.width);
            const y=clamp(ev.clientY-pr.top -b.height/2,0,pr.height-b.height);
            stampGhost.style.left=x+'px'; stampGhost.style.top=y+'px';
          };
          const placeAt=async()=>{
            if(!stampMode||!stampImageObj) return;
            // ìŠ¤íƒ¬í”„ PNG ë¡œë“œ ë³´ì¥
            try{
              if (!stampImageObj.complete || stampImageObj.naturalWidth === 0) {
                await stampImageObj.decode?.();
              }
            }catch(e){
              alert('ë„ì¥ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ ê²½ë¡œë‚˜ ì´ë¦„ì„ í™•ì¸í•˜ì„¸ìš”.');
              cancelStampGhost();
              return;
            }
            const pr=leavesLayer.getBoundingClientRect();
            const gb=stampGhost.getBoundingClientRect();
            const x=(gb.left-pr.left)+gb.width/2;
            const y=(gb.top -pr.top )+gb.height/2;
            const sx=stampCanvas.width/pr.width, sy=stampCanvas.height/pr.height;
            const cx=x*sx, cy=y*sy;
            const size=gb.width*sx, half=size/2;

            sctx.save();
            sctx.translate(cx,cy);
            sctx.rotate(stampRot*Math.PI/180);
            sctx.drawImage(stampImageObj,-half,-half,size,size);
            sctx.restore();

            stampMode=false; setTool('none'); cancelStampGhost(); pushStateIfChanged();
          };
          sketch.addEventListener('pointermove',moveGhost,{once:false});
          sketch.addEventListener('click',placeAt,{once:true});
        });
        stampChooser.appendChild(im);
      });
    }
    buildStamps();

    /* ---------- Undo / Redo (ë””ë°”ìš´ìŠ¤) ---------- */
    const undoStack=[]; const redoStack=[];
    let lastSig=null, pushTimer=null;

    function schedulePush(){
      clearTimeout(pushTimer);
      pushTimer=setTimeout(()=>{ pushStateIfChanged(); }, 200);
    }

    function stateSignature(snap){
      const itemsSig = snap.items.map(it=>[it.src,it.left,it.top,it.w,it.rot]).join('|');
      return itemsSig + '::' + snap.drawData.length + ':' + snap.stampData.length;
    }
    function snapshot(){
      const items=[...leavesLayer.querySelectorAll('img.movable')].map(img=>({
        src:img.src, left:img.style.left, top:img.style.top, w:img.style.width, rot:img.dataset.rotation
      }));
      let drawData='';
      let stampData='';
      try{ drawData=drawCanvas.toDataURL('image/png'); }catch(e){ drawData=''; }
      try{ stampData=stampCanvas.toDataURL('image/png'); }catch(e){ stampData=''; }
      return {items, drawData, stampData};
    }
    async function restoreState(snap){
      leavesLayer.innerHTML='';
      snap.items.forEach(it=>{
        const el=document.createElement('img');
        el.src=it.src; el.className='movable'; el.draggable=false;
        el.style.width=it.w; el.style.height='auto'; el.style.objectFit='contain';
        el.dataset.rotation=it.rot; el.style.transform=`rotate(${it.rot}deg)`;
        el.style.left=it.left; el.style.top=it.top;
        leavesLayer.appendChild(el);
        makeDraggable(el);
      });
      await drawDataUrl(drawCanvas, snap.drawData);
      await drawDataUrl(stampCanvas, snap.stampData);
    }
    function drawDataUrl(canvas, data){
      return new Promise(res=>{
        const img=new Image();
        img.onload=()=>{ const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); res(); };
        img.onerror=()=>res(); img.src=data||'';
      });
    }
    function pushStateIfChanged(){
      const snap=snapshot();
      const sig=stateSignature(snap);
      if(sig!==lastSig){
        undoStack.push(snap);
        if(undoStack.length>80) undoStack.shift();
        lastSig=sig;
        redoStack.length=0;
      }
    }
    async function undo(){
      if(undoStack.length<2) return;
      const cur=undoStack.pop();
      const prev=undoStack[undoStack.length-1];
      redoStack.push(cur);
      await restoreState(prev);
      lastSig=stateSignature(prev);
    }
    async function redo(){
      if(!redoStack.length) return;
      const next=redoStack.pop();
      undoStack.push(next);
      await restoreState(next);
      lastSig=stateSignature(next);
    }
    document.getElementById('btnUndo').addEventListener('click', undo);
    document.getElementById('btnRedo').addEventListener('click', redo);

    /* ---------- Save (PNGë¡œ í•œ ì¥ì— í•©ì„±) ---------- */
    function loadImage(src){
      return new Promise((resolve,reject)=>{
        const im=new Image();
        // ê°™ì€ ì˜¤ë¦¬ì§„ì—ì„œ ì„œë¹„ìŠ¤í•˜ëŠ” ê²½ìš° crossOrigin ìƒëµì´ ì•ˆì „
        im.onload=()=>resolve(im);
        im.onerror=reject;
        im.src=src;
      });
    }

    saveFab.addEventListener('click', async ()=>{
      try{
        const out=document.createElement('canvas'); out.width=drawCanvas.width; out.height=drawCanvas.height;
        const octx=out.getContext('2d');

        // 1) ì—½ì„œ ë°°ê²½ (ë™ì¼ ì¶œì²˜ ê¶Œì¥)
        const bg=await loadImage('ì—½ì„œ1.png');
        octx.drawImage(bg,0,0,out.width,out.height);

        // 2) ë°°ì¹˜ ì´ë¯¸ì§€(ë‚™ì—½/ì—´ë§¤/ê°€ì§€)
        const items=[...leavesLayer.querySelectorAll('img.movable')];
        for(const img of items){
          const im=await loadImage(img.src);
          const rect=img.getBoundingClientRect();
          const pr=leavesLayer.getBoundingClientRect();
          const sx=out.width/pr.width, sy=out.height/pr.height;
          const x=(rect.left-pr.left)*sx, y=(rect.top-pr.top)*sy, w=rect.width*sx, h=rect.height*sy;
          const rot=(parseFloat(img.dataset.rotation)||0)*Math.PI/180;
          octx.save(); octx.translate(x+w/2,y+h/2); octx.rotate(rot);
          octx.drawImage(im,-w/2,-h/2,w,h);
          octx.restore();
        }

        // 3) ë„ì¥ (íˆ¬ëª… í¬í•¨)
        octx.drawImage(stampCanvas,0,0);
        // 4) í¬ë ˆíŒŒìŠ¤ ë“œë¡œì‰
        octx.drawImage(drawCanvas,0,0);

        // 5) ë‹¤ìš´ë¡œë“œ (CORS ì‹¤íŒ¨ ëŒ€ë¹„ ì•ˆì „ ì²˜ë¦¬)
        let url;
        try{ url = out.toDataURL('image/png'); }
        catch(e){ throw new Error('CORS_TAINT'); }

        const a=document.createElement('a');
        a.download='autumn_postcard.png';
        a.href=url;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }catch(err){
        if(err && err.message==='CORS_TAINT'){
          alert('ì €ì¥ì€ ë¡œì»¬ ì„œë²„(ì˜ˆ: VS Code Live Server, ë˜ëŠ” í„°ë¯¸ë„ì—ì„œ\npython -m http.server)ë¡œ http:// ë¡œ ì—´ì–´ì•¼ í•´ìš”.\nfile:// ë¡œ ì—´ë©´ ë³´ì•ˆìƒ toDataURLì´ ë§‰í˜€ìš”.');
        }else{
          alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ì´ë¯¸ì§€ ê²½ë¡œë‚˜ CORS ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          console.error(err);
        }
      }
    });

    /* ---------- Init ---------- */
    setTool('none');

    // ì´ˆê¸° ë°°ì¹˜ í›„ ê¼¬ë¦¬ ë°©í–¥ í•œ ë²ˆ ì—…ë°ì´íŠ¸
    window.addEventListener('load',()=>{
      const wheelTail = document.getElementById('wheelTail');
      const wheelHelp = document.getElementById('wheelHelp');
      const animalRight = document.querySelector('.animal-right');
      if(wheelTail&&wheelHelp&&animalRight){ pointTailToTarget(wheelTail, wheelHelp, animalRight); }
    });
  </script>
</body>

</html>

